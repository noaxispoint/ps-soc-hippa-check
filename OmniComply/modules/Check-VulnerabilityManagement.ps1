<#
.SYNOPSIS
    Validates Vulnerability Management Controls
.DESCRIPTION
    Tests vulnerability scanning configuration, patch management logs, and security assessment history
    PCI-DSS 6.2, 11.3 | SOC 2 CC7.1 | NIST 800-53 RA-5
#>

Write-Host "Checking Vulnerability Management..." -ForegroundColor Cyan

# Check Windows Update history for recent vulnerability patches
try {
    $updateSession = New-Object -ComObject Microsoft.Update.Session
    $updateSearcher = $updateSession.CreateUpdateSearcher()
    $historyCount = $updateSearcher.GetTotalHistoryCount()

    if ($historyCount -gt 0) {
        # Get last 50 updates
        $updateHistory = $updateSearcher.QueryHistory(0, [Math]::Min(50, $historyCount))

        # Count security updates
        $securityUpdates = $updateHistory | Where-Object {
            $_.Title -match "Security|Critical|Cumulative"
        }

        $hasSecurityUpdates = $securityUpdates.Count -gt 0

        Add-ComplianceCheck -Category "Vulnerability Management" `
            -Check "Security Update History" `
            -Requirement "PCI-DSS 6.2 - Security patch deployment" `
            -NIST "SI-2" `
            -CIS "7.1" `
            -ISO27001 "A.12.6.1" `
            -PCIDSS "6.2" `
            -Passed $hasSecurityUpdates `
            -CurrentValue "$($securityUpdates.Count) security update(s) in recent history" `
            -ExpectedValue "Security updates installed regularly" `
            -Remediation "Install security updates via Windows Update or WSUS"

        if ($hasSecurityUpdates) {
            Write-Host "  [PASS] $($securityUpdates.Count) security update(s) found in installation history" -ForegroundColor Green

            # Get most recent security update
            $mostRecent = $securityUpdates | Sort-Object -Property Date -Descending | Select-Object -First 1
            if ($mostRecent) {
                Write-Host "    Most recent: $($mostRecent.Title) - $($mostRecent.Date.ToString('yyyy-MM-dd'))" -ForegroundColor Gray
            }
        } else {
            Write-Host "  [WARN] No security updates found in recent history" -ForegroundColor Yellow
        }

    } else {
        Write-Host "  [INFO] No update history available" -ForegroundColor Gray
    }

} catch {
    Write-Host "  [INFO] Unable to query update history: $($_.Exception.Message)" -ForegroundColor Gray
}

# Check for third-party vulnerability scanners (common tools)
$vulnerabilityScanners = @(
    @{ Name = "Qualys"; Service = "QualysAgent"; Display = "Qualys Cloud Agent" },
    @{ Name = "Nessus"; Service = "Tenable Nessus"; Display = "Tenable Nessus Scanner" },
    @{ Name = "Rapid7"; Service = "ir_agent"; Display = "Rapid7 Insight Agent" },
    @{ Name = "CrowdStrike"; Service = "CSFalconService"; Display = "CrowdStrike Falcon Sensor" },
    @{ Name = "Microsoft Defender"; Service = "Sense"; Display = "Windows Defender Advanced Threat Protection" }
)

$detectedScanners = @()

foreach ($scanner in $vulnerabilityScanners) {
    $service = Get-Service -Name $scanner.Service -ErrorAction SilentlyContinue

    if ($service) {
        $detectedScanners += $scanner.Display
        Write-Host "  [INFO] $($scanner.Display) detected [$($service.Status)]" -ForegroundColor Gray
    }
}

if ($detectedScanners.Count -gt 0) {
    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Vulnerability Scanner Installed" `
        -Requirement "PCI-DSS 11.3 - External and internal vulnerability scans" `
        -NIST "RA-5" `
        -CIS "18.1" `
        -ISO27001 "A.12.6.1" `
        -PCIDSS "11.3.1" `
        -Passed $true `
        -CurrentValue "Scanner(s) installed: $($detectedScanners -join ', ')" `
        -ExpectedValue "Approved vulnerability scanner deployed" `
        -Remediation "Vulnerability scanner is installed"

    Write-Host "  [PASS] Vulnerability scanner detected: $($detectedScanners -join ', ')" -ForegroundColor Green
} else {
    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Vulnerability Scanner Installed" `
        -Requirement "PCI-DSS 11.3 - Quarterly vulnerability scans" `
        -NIST "RA-5" `
        -CIS "18.1" `
        -ISO27001 "A.12.6.1" `
        -PCIDSS "11.3.1" `
        -Passed $false `
        -CurrentValue "No recognized vulnerability scanner detected" `
        -ExpectedValue "Approved Scanning Vendor (ASV) solution deployed" `
        -Remediation "Install approved vulnerability scanning solution (Qualys, Nessus, Rapid7, etc.)"

    Write-Host "  [WARN] No recognized vulnerability scanner detected" -ForegroundColor Yellow
}

# Check Windows Security Center for security product registration
try {
    $securityCenter = Get-CimInstance -Namespace "root/SecurityCenter2" -ClassName "AntiVirusProduct" -ErrorAction Stop

    if ($securityCenter) {
        foreach ($av in $securityCenter) {
            Write-Host "  [INFO] Security product registered: $($av.displayName)" -ForegroundColor Gray
        }
    }

} catch {
    # SecurityCenter2 namespace may not be available on servers
    Write-Host "  [INFO] Security Center query not available (normal on servers)" -ForegroundColor Gray
}

# Check for scheduled vulnerability assessment tasks
$scheduledTasks = Get-ScheduledTask -ErrorAction SilentlyContinue | Where-Object {
    $_.TaskName -match "Scan|Vuln|Security|Patch|Assessment"
}

if ($scheduledTasks) {
    $activeTasks = $scheduledTasks | Where-Object { $_.State -ne 'Disabled' }

    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Scheduled Security Assessment Tasks" `
        -Requirement "PCI-DSS 11.3 - Regular vulnerability assessments" `
        -NIST "RA-5(1)" `
        -ISO27001 "A.12.6.1" `
        -PCIDSS "11.3.2" `
        -Passed ($activeTasks.Count -gt 0) `
        -CurrentValue "$($activeTasks.Count) active security assessment task(s)" `
        -ExpectedValue "Scheduled vulnerability assessments configured" `
        -Remediation "Configure scheduled vulnerability scans via scanner management console"

    if ($activeTasks.Count -gt 0) {
        Write-Host "  [PASS] $($activeTasks.Count) active security assessment task(s) scheduled" -ForegroundColor Green

        foreach ($task in $activeTasks | Select-Object -First 5) {
            Write-Host "    - $($task.TaskName)" -ForegroundColor Gray
        }
    } else {
        Write-Host "  [INFO] No active security assessment tasks found" -ForegroundColor Gray
    }

} else {
    Write-Host "  [INFO] No scheduled security assessment tasks detected" -ForegroundColor Gray
}

# Check for patch compliance monitoring (WSUS client)
$wsusClient = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate" -ErrorAction SilentlyContinue

if ($wsusClient -and $wsusClient.WUServer) {
    $wsusServer = $wsusClient.WUServer

    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Centralized Patch Management (WSUS/SCCM)" `
        -Requirement "PCI-DSS 6.2 - Centralized patch deployment" `
        -NIST "SI-2(2)" `
        -CIS "7.1" `
        -ISO27001 "A.12.6.1" `
        -PCIDSS "6.2" `
        -SOX "ITGC-06" `
        -Passed $true `
        -CurrentValue "WSUS Server: $wsusServer" `
        -ExpectedValue "Centralized patch management configured" `
        -Remediation "WSUS/SCCM is configured"

    Write-Host "  [PASS] Centralized patch management configured: $wsusServer" -ForegroundColor Green
} else {
    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Centralized Patch Management" `
        -Requirement "PCI-DSS 6.2 - Patch management process" `
        -NIST "SI-2(2)" `
        -CIS "7.1" `
        -PCIDSS "6.2" `
        -SOX "ITGC-06" `
        -Passed $false `
        -CurrentValue "No WSUS/SCCM server configured" `
        -ExpectedValue "Centralized patch management via WSUS or SCCM" `
        -Remediation "Configure WSUS via Group Policy or manually: Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name 'WUServer' -Value 'http://wsus-server'"

    Write-Host "  [INFO] No centralized patch management (WSUS/SCCM) detected" -ForegroundColor Gray
}

# Check for CVE tracking / vulnerability feed subscriptions
# Look for common vulnerability database files or registry keys
$vulnDatabases = @(
    "C:\ProgramData\Qualys",
    "C:\Program Files\Tenable\Nessus\nessus\plugins",
    "C:\Program Files\Rapid7",
    "C:\ProgramData\Microsoft\Windows Defender\Definition Updates"
)

$vulnDbFound = $false

foreach ($dbPath in $vulnDatabases) {
    if (Test-Path $dbPath) {
        $vulnDbFound = $true
        Write-Host "  [INFO] Vulnerability database found: $dbPath" -ForegroundColor Gray
        break
    }
}

if ($vulnDbFound) {
    Add-ComplianceCheck -Category "Vulnerability Management" `
        -Check "Vulnerability Database Updates" `
        -Requirement "PCI-DSS 11.3 - Current vulnerability information" `
        -NIST "RA-5(3)" `
        -PCIDSS "11.3.1" `
        -Passed $true `
        -CurrentValue "Vulnerability database detected and likely updating" `
        -ExpectedValue "Current vulnerability signatures/definitions" `
        -Remediation "Ensure vulnerability scanner updates regularly"

    Write-Host "  [PASS] Vulnerability database detected (likely receiving updates)" -ForegroundColor Green
}

# Check for penetration testing evidence (look for common pen-test tool directories)
$pentestTools = @(
    "C:\Program Files\Metasploit",
    "C:\Program Files\Burp Suite",
    "C:\Tools\nmap"
)

$pentestFound = $false

foreach ($toolPath in $pentestTools) {
    if (Test-Path $toolPath) {
        $pentestFound = $true
        Write-Host "  [INFO] Penetration testing tool detected: $toolPath (verify authorized use)" -ForegroundColor Gray
    }
}

if ($pentestFound) {
    Write-Host "  [INFO] Penetration testing tools detected - ensure only authorized security teams have access" -ForegroundColor Gray
}

# Check Event Log for vulnerability scan events
try {
    # Look for security assessment events in System or Application logs
    $scanEvents = Get-WinEvent -LogName "Application" -MaxEvents 100 -ErrorAction SilentlyContinue |
        Where-Object { $_.Message -match "scan|vulnerability|assessment" }

    if ($scanEvents) {
        Write-Host "  [INFO] $($scanEvents.Count) vulnerability assessment related events found in logs" -ForegroundColor Gray
    }

} catch {
    # No scan events found
}

Write-Host ""
